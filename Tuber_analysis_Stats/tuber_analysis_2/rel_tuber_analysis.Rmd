---
title: "Tuber_analysis_2"
author: "Max Miao"
date: "June 21, 2019"
output:
  html_document:
    df_print: paged
---

Found some extra Tubers. Need to reanalyze:

## Re-examining datasets and recalculating reletivized values:

```{r}
library(tidyverse)
meta_tuber_data <- read.csv("tuber_analysis_2.csv", header = T)

#extracting rows to calculate sterile averages for each variety 
sterile_avg = meta_tuber_data %>%
  filter(soil == "Sterile", tuber3 != "#NA") %>%
  group_by(variety2,Clade,Nutrient) %>%
  summarize(mean(tuber3),n = n()) %>%
  rename(sterile_avg = "mean(tuber3)")


#Now we want to calculate relativized values shoot/avg for each variety
meta_tuber_data <- merge(meta_tuber_data,sterile_avg, by=c("variety2","Nutrient"))

#relativize our values:
new_meta_data <- transform(meta_tuber_data, rel_biomass = tuber3/sterile_avg)
write.csv(new_meta_data,"rel_tuber_analysis.csv")

```

So, we have a math issue. We can't divide by zero. So we'll maybe do a weighted average for each clade. Also we will then test to see if tubermass variation is greater between clades than within. We hope to see that tubermass variation is greater between clades and not within. 
```{r}
#Calculate Weighted Average
meta_tuber_data <- read.csv("tuber_analysis_2.csv", header = T)
wgt_average = meta_tuber_data  %>%
  filter(soil == "Sterile") %>%
  group_by(agerank2,Nutrient) %>%
  summarise(tuber_mean=mean(tuber3),n=n()) %>%
  summarise(wgt_avg = weighted.mean(tuber_mean,n),obs=sum(n))

#Merge Data set to "new_meta_data"
meta_tuber_data <- merge(meta_tuber_data,wgt_average, by=c("agerank2"))

#WOW now we have our weighted averages based on clade and nutrient regime. We will now proceed to relativizing based on weighted average just calculated. 

new_meta_data2 <- transform(meta_tuber_data, rel_biomass2 = tuber3/wgt_avg)
write.csv(new_meta_data2, "rel_tuber_analysis.csv")

#to Verify that this method is sound perform a statistical test:
library(lme4)
library(lmerTest)
a <- lmer(rel_biomass2 ~ Clade*Nutrient + variety2 + (1|Clade:variety2), data = new_meta_data2)
summary(a)
anova(a)

b <- lmer(tuber3 ~ Clade*Nutrient + variety2 + (1|Clade:variety2), data = new_meta_data2)
summary(b)
anova(b)
```
We now can say that weighted average method was alright! Don't have to worry about genotype effect because its not statistically significant. There's a statistical significant difference in how the plant are reacting to fertilizer treatment. 

#Model fitting

```{r}
rel_tuber <- lmer(rel_biomass2 ~ Nutrient*agerank2*soil + (1|Variety), data = subset(new_meta_data2, agerank2 != 1, soil != "Sterile"))
summary(rel_tuber)
anova(rel_tuber)
```
Relative tuber yield doesn't too different between Hancock vs Virgin Prarie. Nutrient of course makes a difference. Soil we see a difference in Sterile vs non-sterile soils. Hard to say anything else. Agerank we do see a overall main effect. But more importantly a strong interaction effect low nutrient conditions:agerank2. This is very compelling. However, do not see a difference in soil:agerank2. This makes sense in terms of the genetics of the plant are taught to respond very differently. But I can't say anything for certain about soil. Previously claimed that soil has a effect but it no longer seems to be the case. We can say that overall seems to be a trend that in Virgin soil plants overall grew better...


```{r}
new_data <- subset(new_meta_data2, agerank2 != 1, soil != "Sterile")
new_data <- subset(new_data, Nutrient == "Low")
rel_tuber <- lmer(rel_biomass2 ~ agerank2*soil + (1|Variety), data = new_data) 
summary(rel_tuber)
anova(rel_tuber)

```

```{r}
new_data <- subset(new_meta_data2, agerank2 != 1, soil != "Sterile")
new_data <- subset(new_data, Nutrient == "High")
rel_tuber <- lmer(rel_biomass2 ~ agerank2*soil + (1|Variety), data = new_data) 
summary(rel_tuber)
anova(rel_tuber)
```


#Making Summarised data sets for graphing
```{r}
library(tidyverse)
library(plotrix)
rel_avg = new_meta_data2 %>%
  filter(soil != "Sterile", agerank2 != "1") %>%
  group_by(agerank2,Nutrient) %>%
  summarise(mean = mean(rel_biomass2), sd=sd(rel_biomass2), n = n(), se = std.error(rel_biomass2))

rel_avg2 = new_meta_data2 %>%
  filter(soil != "Sterile", agerank2 != "1") %>%
  group_by(agerank2,soil,Nutrient) %>%
  summarise(mean = mean(rel_biomass2), sd=sd(rel_biomass2), n = n(), se = std.error(rel_biomass2))
rel_avg_high = subset(rel_avg2, Nutrient == "High")
rel_avg_low = subset(rel_avg2, Nutrient == "Low")

```


## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
library(ggplot2)
rel_avg$agerank2 = as.factor(rel_avg$agerank2)
ggplot(rel_avg)+
  aes(x = Nutrient, y = mean, color = agerank2)+
  scale_x_discrete(name = "Nutrient", limits = c("High", "Low"))+
  scale_y_continuous(name =  "relative tubermass")+
  geom_line(aes(linetype=agerank2), size=.6)+
  geom_point(aes(shape=agerank2), size=3)+
  geom_errorbar(aes(ymax=mean+se, ymin=mean-se), width=.1)
```

See agerank 2 and agerank 3 (Andigenum and Chiletanum) they increase in relative tuber yield. While the opposite is true for Agerank 4 and 5 (Garnett Chili and Elite). 

```{r}
rel_avg$agerank2 = as.factor(rel_avg$agerank2)
ggplot(rel_avg_high)+
  aes(x = agerank2, y = mean, color = soil)+
  scale_x_discrete(name = "Agerank", limits = c(" ", "Andigeum","Chiletanum", "G. Chili", "Modern"))+
  scale_y_continuous(name =  "Microbial Yield Reponse")+
  geom_line(aes(linetype=soil), size=.6)+
  geom_point(aes(shape=soil), size=3)+
  geom_errorbar(aes(ymax=mean+se, ymin=mean-se), width=.1)+
    theme_classic()+
  theme(axis.title.x = element_text(face="bold", size=15))+
  theme(axis.title.y = element_text(face="bold", size=15))
```

So we see that more modern perform better in term of tubermass in high nutrient conditions. Also, see a additive microbial effect in that with more modern varieties we see a boast relative to sterile. However, with fertilizer we see that landraces perform more poorly that sterile. 


```{r}
rel_avg_low$agerank2 = as.factor(rel_avg_low$agerank2)
ggplot(rel_avg_low)+
  aes(x = soil, y = mean, color = agerank2)+
  scale_x_discrete(name = "soil", limits = c("Virgin", "Hancock"))+
  scale_y_continuous(name = "relative tubermass")+
  geom_line(aes(linetype=agerank2), size=.6)+
  geom_point(aes(shape=agerank2), size=3)+
  geom_errorbar(aes(ymax=mean+se, ymin=mean-se), width=.1)
```

Interestingly there's no soil interaction effect. Or at least it isn't strong enought to see any differences in low nutrient conditions. We can maybe say that Andigenum (agerank 2) did alot better in hancock than in Virgin. This is due to a soil effect? 


#Hypothesis: Elite Varieties will be less dependent on soil microbial communities. Especially in low nutrient condtions. 

We are now trying to measure plant response to microbes. 

```{r}
new_data <- subset(new_meta_data2, agerank2 != "1" & soil != "Sterile")
new_data <- subset(new_data, Nutrient == "Low")

rel_tuber <- lmer(rel_biomass2 ~ agerank2*soil + (1|Clade:variety2), data = new_data)
summary(rel_tuber)
anova(rel_tuber)
```
Genotype was the only thing that mattered in determining variance in relative tuber yield...

##Plot of tuber yield in low nutrient conditions. 

```{r}
rel_avg_low$agerank2 = as.integer(rel_avg_low$agerank2)
ggplot(rel_avg_low)+
  aes(x = agerank2, y = mean, color = soil)+
  scale_x_discrete(name = "Age rank", limits = c( "Andigenum","Chiletanum", "G. Chili", "Modern"))+
  scale_y_continuous(name = "Microbial Yield Response")+
  geom_line(aes(linetype=soil), size=.6)+
  geom_point(aes(shape=soil), size=3)+
  geom_errorbar(aes(ymax=mean+se, ymin=mean-se), width=.1)+
  theme_classic()+
  theme(axis.title.x = element_text(face="bold", size=15))+
  theme(axis.title.y = element_text(face="bold", size=15))
```

Looks like over all in low nutrient conditions, tuber yield was greater in more ancestral lines than more recent. Doesn't matter the soil inoculum but we see that in both hancock and virgin more ancestral lines perform better. Overall, see relative tuber yield making a positive difference in low nutrient conditions in live soil. This isn't the case with more modern potato varieties because see that they actually perform more poorly than in sterile conditions. In contrast in high fertilizer conditions we see the exact opposite effect where modern varieties regardless of soil see a additional additive fertilizer + microbial treatment effect. This is pretty interesting. 
